suite: test server deployment

templates:
  - templates/deployment.yaml

set:
  global:
    image:
      registry:
  image:
    revision: 1

chart:
  appVersion: 1.2.3
  version: 2.6.12

release:
  name: unittest

tests:
  - it: should not use the init-container wait-for-influx if influx isn't used
    set:
      plugins:
        influxdb:
          enable: false
    asserts:
      - notExists:
          path: spec.template.spec.initContainers
  - it: should not use the init-container wait-for-influx if influx is external
    set:
      plugins:
        influxdb:
          enable: true
          host: a.b.c.d
    asserts:
      - notExists:
          path: spec.template.spec.initContainers
  - it: shouldn't have prometheus specific fields if not enabled
    set:
      plugins:
        prometheusExporter:
          port: 4567
    asserts:
      - notExists:
          path: spec.template.metadata["prometheus.io/scrape"]
      - notContains:
          path: spec.template.spec.containers[0].ports
          content:
            - containerPort: 4567
              name: 'exporter'
      - equal:
          path: spec.template.spec.containers[0].name
          value: alumet-relay-server
  - it: shouldn't have any toleration by default
    asserts:
      - lengthEqual:
          path: spec.template.spec.tolerations
          count: 0
  - it: should use global values in priority
    set:
      global:
        secret: abc
        image:
          registry: registry.com
      secret: 123
      image:
        registry: registry.net
    asserts:
      - contains:
          path: spec.template.spec.imagePullSecrets
          content:
            name: abc
      - notContains:
          path: spec.template.spec.imagePullSecrets
          content:
            name: 123
      - equal:
          path: spec.template.spec.containers[0].image
          value: registry.com/alumet-agent:1.2.3-1_ubuntu_24.04
